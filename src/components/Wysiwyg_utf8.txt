import React, { useEffect, useRef, useState } from "react";

export type WysiwygProps = {
  value: string;
  onChange: (html: string) => void;
  className?: string;
  placeholder?: string;
};

function sanitize(html: string): string {
  const div = document.createElement("div");
  div.innerHTML = html || "";
  div.querySelectorAll("script").forEach((n) => n.remove());
  const walker = document.createTreeWalker(div, NodeFilter.SHOW_ELEMENT, null);
  while (walker.nextNode()) {
    const el = walker.currentNode as HTMLElement;
    [...el.attributes].forEach((a) => {
      if (a.name.startsWith("on")) el.removeAttribute(a.name);
      if (a.name === "style" && /expression|url\(/i.test(a.value)) el.removeAttribute("style");
    });
  }
  return div.innerHTML;
}

export default function Wysiwyg({ value, onChange, className, placeholder }: WysiwygProps) {
  const ref = useRef<HTMLDivElement>(null);
  const lastRangeRef = useRef<Range | null>(null);
  const fileRef = useRef<HTMLInputElement>(null);
  const [hasLink, setHasLink] = useState(false);
  const [imgNode, setImgNode] = useState<HTMLImageElement | null>(null);
  const [imgScale, setImgScale] = useState<number>(100);

  useEffect(() => {
    const el = ref.current;
    if (!el) return;
    if (el.innerHTML !== value) el.innerHTML = value || "";
  }, [value]);

  const updateContextFromSelection = () => {
    const el = ref.current;
    if (!el) return;
    const sel = window.getSelection();
    let node: Node | null = sel && sel.rangeCount ? sel.getRangeAt(0).commonAncestorContainer : null;
    if (node && node.nodeType === Node.TEXT_NODE) node = node.parentNode;
    let cur: Node | null = node;
    let link: HTMLAnchorElement | null = null;
    let img: HTMLImageElement | null = null;
    while (cur && cur !== el) {
      const tag = (cur as HTMLElement).tagName;
      if (tag === 'A') link = cur as HTMLAnchorElement;
      if (tag === 'IMG') img = cur as HTMLImageElement;
      cur = cur.parentNode;
    }
    setHasLink(!!link);
    setImgNode(img);
    if (img) {
      const w = (img.style.width || '').trim();
      const perc = w.endsWith('%') ? parseInt(w, 10) : 100;
      setImgScale(Number.isFinite(perc) ? perc : 100);
    }
  };

  const saveSelection = () => {
    const sel = window.getSelection();
    if (sel && sel.rangeCount > 0) {
      lastRangeRef.current = sel.getRangeAt(0);
    }
    updateContextFromSelection();
  };

  const restoreSelection = () => {
    const el = ref.current;
    if (!el) return;
    const sel = window.getSelection();
    const r = lastRangeRef.current;
    if (sel && r) {
      sel.removeAllRanges();
      sel.addRange(r);
    } else if (el.firstChild) {
      const range = document.createRange();
      range.selectNodeContents(el);
      range.collapse(false);
      sel?.removeAllRanges();
      sel?.addRange(range);
    }
  };

  const exec = (cmd: string, arg?: string) => {
    restoreSelection();
    document.execCommand(cmd, false, arg);
    ref.current?.focus();
    saveSelection();
  };

  const handleInput = () => {
    const html = sanitize(ref.current?.innerHTML || "");
    onChange(html);
    saveSelection();
  };

  const handlePickImage = () => fileRef.current?.click();
  const onFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const f = e.target.files?.[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = String(reader.result || "");
      restoreSelection();
      const html = `<img src="${dataUrl}" style="max-width:100%;height:auto;width:100%" alt=""/>`;
      document.execCommand("insertHTML", false, html);
      handleInput();
    };
    reader.readAsDataURL(f);
    e.target.value = "";
  };

  const changeImgScale = (val: number) => {
    setImgScale(val);
    if (imgNode) {
      imgNode.style.width = `${val}%`;
      imgNode.style.maxWidth = '100%';
      imgNode.style.height = 'auto';
      handleInput();
    }
  };

  return (
    <div className={className}>
      <div className="flex flex-wrap items-center gap-1 mb-2" onMouseDown={(e) => e.preventDefault()}>
        {/* Block type */}
        <select className="h-8 px-2 rounded border bg-white text-black" title="Lohkon tyyppi" onMouseDown={(e)=>e.preventDefault()} onChange={(e)=>exec('formatBlock', e.target.value)} defaultValue="p">
          <option value="p">LeipÃ¤teksti</option>
          <option value="h1">Otsikko 1</option>
          <option value="h2">Otsikko 2</option>
          <option value="h3">Otsikko 3</option>
          <option value="blockquote">Lainaus</option>
          <option value="pre">Koodilohko</option>
        </select>

        {/* Inline formatting */}
        <button type="button" title="Lihavointi" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); exec('bold');}}>B</button>
        <button type="button" title="Kursivointi" className="px-2 py-1 rounded border italic" onMouseDown={(e)=>{e.preventDefault(); exec('italic');}}>I</button>
        <button type="button" title="Alleviivaus" className="px-2 py-1 rounded border underline" onMouseDown={(e)=>{e.preventDefault(); exec('underline');}}>U</button>
        <button type="button" title="Yliviivaus" className="px-2 py-1 rounded border line-through" onMouseDown={(e)=>{e.preventDefault(); exec('strikeThrough');}}>S</button>

        {/* Lists */}
        <button type="button" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); exec('insertUnorderedList');}}>â€¢ Lista</button>
        <button type="button" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); exec('insertOrderedList');}}>1. Lista</button>
        <button type="button" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); restoreSelection(); document.execCommand('insertHTML', false, '<ul class=\"checklist\"><li><input type=\"checkbox\"/>Â </li></ul>'); saveSelection();}}>â˜‘ LisÃ¤Ã¤ tehtÃ¤vÃ¤</button>

        {/* Indent/align */}
        <button type="button" className="px-2 py-1 rounded border" title="Vasen" onMouseDown={(e)=>{e.preventDefault(); exec('outdent');}}>L</button>
        <button type="button" title="SisennÃ¤" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); exec('indent');}}>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7h12M3 12h18M3 17h12"/><path d="M18 8l3 3-3 3"/></svg>
        </button>
        <button type="button" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); exec('justifyLeft');}}>L</button>
        <button type="button" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); exec('justifyCenter');}}>C</button>
        <button type="button" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); exec('justifyRight');}}>R</button>

        {/* Links / media */}
        <button type="button" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); const url = prompt('Linkin URL'); if (url) exec('createLink', url);}}>Linkki</button>
        <button type="button" className="px-2 py-1 rounded border disabled:opacity-40" disabled={!hasLink} title="Poista linkki" onMouseDown={(e)=>{e.preventDefault(); if (hasLink) exec('unlink');}}>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 15L15 9"/><path d="M10.5 4.5l9 9a3 3 0 01-4.24 4.24l-9-9A3 3 0 0110.5 4.5z"/></svg>
        </button>
        <button type="button" className="px-2 py-1 rounded border" title="Kuva" onMouseDown={(e)=>{e.preventDefault(); handlePickImage();}}>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 15l4-4 4 4 5-5 4 4"/><circle cx="8.5" cy="8.5" r="1.5"/></svg>
        </button>
        <input ref={fileRef} type="file" accept="image/*" onChange={onFileChange} className="hidden" />
        <button type="button" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); exec('insertHorizontalRule');}}>Hâ€‘viiva</button>

        {/* History / cleanup */}
        <button type="button" className="px-2 py-1 rounded border" title="Undo" onMouseDown={(e)=>{e.preventDefault(); exec('undo');}}>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7v6h6"/><path d="M3 13a9 9 0 109-9"/></svg>
        </button>
        <button type="button" className="px-2 py-1 rounded border" title="Redo" onMouseDown={(e)=>{e.preventDefault(); exec('redo');}}>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 7v6h-6"/><path d="M21 13a9 9 0 11-9-9"/></svg>
        </button>
        <button type="button" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); exec('removeFormat');}}>TyhjennÃ¤ muotoilut</button>

        {imgNode && (
          <div className="ml-3 flex items-center gap-2">
            <span className="text-xs opacity-70">Kuvan koko</span>
            <input type="range" min={10} max={100} value={imgScale} onChange={(e)=> changeImgScale(parseInt((e.target as HTMLInputElement).value, 10))} />
            <button type="button" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); changeImgScale(50);}}>50%</button>
            <button type="button" className="px-2 py-1 rounded border" onMouseDown={(e)=>{e.preventDefault(); changeImgScale(100);}}>100%</button>
          </div>
        )}
      </div>

      <div
        ref={ref}
        contentEditable
        onInput={handleInput}
        onKeyUp={saveSelection}
        onMouseUp={saveSelection}
        onFocus={saveSelection}
        onBlur={handleInput}
        className="min-h-[220px] p-3 rounded-md bg-white text-black border outline-none focus:ring-2 focus:ring-zinc-300"
        data-placeholder={placeholder}
        suppressContentEditableWarning
      />
    </div>
  );
}
